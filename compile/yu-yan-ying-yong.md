# 语言应用

在编程人员的职业生涯中，会接触多门语言，无论是解决通用问题的GPPL\(General-Purpose Programming Language\)，亦或是设计用来在某领域解决专用问题的DSL。重新发明语言来解决问题的机会不一定能遇到，针对广泛流传语言做出自己的应用却是力所能及的。

语言应用突出的作用点在提升效能。本篇文章的重点不在晦涩的编译原理，而在做出语言应用所需要的实用知识。

## 编译基础

* 文法：语言的语法结构的形式化描述，每条描述为一条或多条规则。
* 词法解析：理解语言的基础，要识别出语言中的基本单元。计算机语言中，词法单元\(token\)就是这样的基本单元。词法单元一般包含其类型和其内容。词法解析将源代码解析成一序列词法单元。词法解析器叫做lexer。
* 语法解析：有了语言的基本单元，要理解语言，下一步是把单元串起来，形成结构整体理解。语法解析将一序列的词法单元，进行分析并按照其语法构建数据结构。语法解析器叫做parser。

**解析本质：无论是在词法解析阶段还是语法解析阶段，按照文法规则，进行模式匹配。**

## 语法解析器

因为语言是有由基本元素构成复合元素这一性质，解析器的任务就是**求解解析树**，解析树的内部节点为文法规则，叶子节点为文法规则相关的词法单元。求解方式有两种，自顶向下和自底向上。自顶向下从前序构建解析树，先构建文法规则作为内节点，再构建出词法单元作为叶子节点。自底向上从后序构建解析树，先构建出词法单元作为叶子节点，再构建出文法规则作为内节点。

LL解析器则是自顶向下，LR解析器则是自底向上。LL解析器相比于LR解析器更加广泛，LL解析器更易手写并且更加强大。

### LL解析器

LL解析器自顶向下，挨个将匹配单位，在预测\(predict\)出来的前向可能集合中尝试所有选项，匹配出结果，这样要求结果是确定性的，如果有多个可能，要看优先级，这是一个下降的过程。

### LR解析器

不同于LL解析器，LR解析器自底向上。不断将匹配单位移入\(shift\)缓冲区，在缓冲区中可能规则集合中挨个匹配，不断减少\(reduce\)为规则，这是一个上升的过程。

### 解析策略

而不同的解析器，会采用不同的匹配策略。最简单的策略就是只看前向一个单位匹配，复杂的一点，便是看前向K个单位匹配。前向K个匹配策略则需要构建环形缓冲。更加复杂的不能只看前向，还要照顾后向，这种就是回溯匹配，回溯指的是如果出现了匹配错误，把当前匹配的单位向前回退并重新开始。

归根到底，匹配策略的原理就是匹配算法，而针对这个问题，比回溯性能上个等级的就是动态规划，使用动态规划的策略就是记忆化匹配。

以上这四种策略都是上下文无关的，更加复杂的语言，语法解析也需要上下文来解析，这种解析策略叫做谓词匹配，将上下文等额外信息作为谓词加入匹配中。

## AST\(抽象语法树\)

语法解析完毕后，会求解出分析树。然而，分析树包含了很多后续不需要的细节，语法解析输出的是经过抽象过后的AST。相较于解析树，AST隐藏了很多原始语法的细节，并且更加接近计算机求值。

**AST的本质：内节点为操作符，叶子节点为操作对象。而如果没有合适的操作符，找到合适的节点充当虚操作符。**

AST分为几种类型：

* 同型树、异型树：节点不区分类型为同型树，反之则为异型树。同型树易于访问，工程量小，但写出的代码不容易理解。与同型树相比，异型树区分类型写出的代码更易理解，但需要创建过多类型节点，工程量大，Java语言就要超过200个。
* 规则记录子节点、不规则记录子节点：规则记录子节点指的是同一类型节点直接用容器记录子节点。不规则记录子节点则根据节点不同类型，使用不同方式记录子节点。规则记录子节点易于访问。不规则记录子节点写出的代码更易理解。

## 符号跟踪

语法解析后的下一步是语义解析，语义解析能够检查出符合语法但是没有意义的语句，这实际上是模拟求值的过程。符号跟踪是语义解析的基础。

**符号跟踪的本质：跟踪符号的生命周期，在引用它的时候，追溯它的来历。**

### 作用域树

符号的生命周期就是其作用域，符号在作用域中有跨外围作用域的性质，为了方便追溯，会构造作用域树。以下几点是符号跟踪的关键点。

* 外围作用域：在当前作用域无法决议\(resolve\)符号时，会尝试去外围作用域决议。
* 继承作用域：对于有继承能力的作用域，比如说类，在当前作用域无法决议\(resolve\)符号时，要去父类作用域决议。
* 成员访问：在访问数据聚集类型\(data aggregate，包括struct、class）成员变量时，先决议出其主体符号再在其主体符号作用域内决议出其符号。
* 前向引用：存在前向引用的符号跟踪需要经过两次解析\(two phase resolve\)，第一次处理定义，第二次真正决议。

跟踪符号的数据结构就叫做符号表\(symbol table\)。

## 元编程、DSL、模板

### 元编程

一句话来描述元编程：用一门元语言去编目标语言的程序，或者说编写能够编写其他程序的程序。最常见的元语言就是目标语言自己的反射、自省、泛型，这些元类型、元方法可以看做是门语言，目标语言的元语言。

### DSL

设计一门DSL不是难事，但设计一门能广泛流传的DSL是很困难的事。首先，需要对领域精通。比如说要想设计一门制图语言，对图形语法要有自己的见解，而在这方面已有了专门研究的系分，参照[《The Grammer Of Graphics》](https://book.douban.com/subject/10123863/)。其次，需要对计算机语言精通，起码能够嗅出不同语言中的好坏设计。被设计出来的DSL很多，而广为流传的就零星的几个。

### 模板

模板通常用来省去编程人员重复编写类似代码的工作，而DSL和模板是一对好搭档。编程人员记住多种DSL语法是件困难事，模板帮助编程人员忽略DSL语法的细节。

